# Discussion（仿百度贴吧） 开发进度

## 用户模块

### 后端接口实现

#### 用户

**以下所有操作一旦涉及对数据库数据的增删改等操作皆要进行用户权限判断（通过事务传递实现）**

- [x] **登录**
- [x] **注册**
- [x] **收藏贴吧**
- [x] **收藏帖子**
- [x] **用户权限管理（以下权利划分皆为递进，后者拥有前者全部权限）**
  - [x] **普通用户：浏览，评论，回复，删除自己的贴子、评论、回复**
  - [x] **管理员用户：删除任意帖子、评论、回复**
  - [x] **创建者用户：删除贴吧，增设管理员用户，撤销管理员用户，贴吧改名**

#### 贴吧

- [x] **创建**
  - [x] **在贴吧创建的最开始赋予创建者，创建者权利**
- [x] **删除**
  - [x] **同时删除UserToRole表下的相关posts的所有内容（各个用户组的状态记录——真删除）**
- [x] **改名**
- [x] **被搜索**
  - [x] **精确搜索**
  - [x] **模糊搜索**
- [x] **贴吧展示**
  - [x] **分页展示模糊搜索下的所有贴吧**
  - [x] **展示精准搜索下的单个贴吧**
- [x] **权限管理**
  - [x] **创建者增加管理员用户**
  - [x] **创建这降级管理员用户**
  - [x] **创建者用户删除贴吧**（贴吧删除时需要做权限认证）

#### 帖子

- [x] **帖子展示**
  - [x] **分页某个贴吧下的所有帖子展示**
- [x] **被评论以及回复**
- [x] **创建**
  - [x] **登录用户才有权限**
- [x] **删除**
  - [x] **普通用户：自己帖子**
  - [x] **管理员以及创建者：删除任何帖子**
- [x] **内容以及评论展示**
  - [x] **分页展示**

#### 评论以及回复

- [ ] **展示**
  - [ ] **分页展示**
    - [x] **展示评论**
    - [x] **展示回复**
- [x] **创建**
  - [x] **回复**
  - [x] **评论**
- [x] **删除**
  - [x] **普通用户：自己评论，回复**
  - [x] **管理员以及创建者：删除任何评论，回复**
- [x] **评论以及回复提醒**
  - [x] **评论提醒原发帖人**
  - [ ] **回复提醒原评论或回复人**

### 前端

## 待完善功能

1. 只看楼主的功能。
2. @用户
3. 收藏（关注）统计
4. 贴吧分区
5. 用户互相关注

## 实现细节

1. **用户**
   1. **后端**
      1. 为了良好的扩展性，用户表中应该只包含用户基本信息，而用户权限等外加属性，应新建表单以user_id作为主键之一。
      
      2. 用户权限设置中的status，代表用户的权限。1为管理员用户，2为创建者用户，同时在设计数据库表的时候，还应该考虑到，给予每一个posts（贴吧）皆要有相关用户权限设置。所以，主键应为user_id + posts_id，status为外码之一，权限变更应体现在status属性值的更改，而在具体实现中应该以username为检索条件，再对user_id进行联动，已达到修改status需求。
      
      3. 在创建数据库的时候应该将评论和回复分为不同的表中。已达到解耦的目的，且在逻辑上comment表应为reply表的父级表。
      
      4. 在对posts，post，comment等表中数据进行删除的时候应该具体考虑到相关子表的属性应同时进行删除。即，对posts表中记录进行删除的同时，应同时删除post，comment，reply表中与该posts数据相关的数据。
      
      5. 在咨询过大佬后，现决定，将所有的除用户以外的表中的记录，删除皆以软删除处理。但其中对于贴吧，帖子，评论，回复表的数据皆是仅作为存储记录，而在其再次插入表中时，不做恢复处理。
      
      6. 就回复提醒的实现，这里以comment为例提供一种解决方法：首先是comment的人，发出保存comment请求（其中请求参数应包含：target_post，comment_context，comment_man），然后后端在保存成功的前提下，对保存的comment进一步进行处理，通过target_post来连接到post表，然后再通过post中的：create_man，找到发帖人。同时根据comment_man找到相应的评论人，取其username。并以json的格式返回本次评论的（comment_context，create_man，comment_man_username，comment_create_time）。而前端在接收到后端返回的数据之后，可以根据传入的create_man对请求列表进行遍历。并给出ui提醒。
      
      7. 对于在建库时出现的回复的回复问题，解决方案如下：在reply表中给出一个target_reply属性，其没有非空约束，同时也不是外键。即：每个回复都有一个target_comment的外键，但当回复为回复的回复时，target_reply才会被填入相应的的reply的id。而当回复的目标为comment时，target_reply为null。
      
      8. 对于数据库的扩展。遵循能不动就不动原数据库的规定，比如：要再给贴吧进行分类，那么我们，就再重新创建一个表，以kind_id，为主键，外键为posts_id，而外码有：kind_name。
      
      9. 对于user_to_post,user_to_role,user_to_posts，这三个表的处理，暂定为：给予他们entity，dao，service。但是不给他们单独写controller，而是将其附属到各个整表的Controller中。如user_to_role，主要负责对posts和用户的权限管理，那么就把他的Service附加到posts的controller中（最后在实践的过程中为了方便调用，又将User_to_role的service封装进了posts的service中，并添加了一定的数据校准，以及事务的处理）。
      
      10. 对于每个表的controller层级关系。主要冲突的体现点在于上一层controller中可能会调用到部分低层表的Service，但主要用途都是对低层的内容进行显示。并没有具体涉及到增删改的操作。对于每个表的增删改的操作，还是主要存在于其自己的controller中。
      
      11. **问题：**如果在删除贴吧的时候，必须得把帖子，评论等一起删掉，但是如果这里只对贴吧和帖子进行删除，
          然后再在帖子的Service中开启事务删除评论的话，就会出现，在删除贴吧时候就已经把帖子删除并commit了，所以到删除评论的时候就找不到
          相应的帖子了，也就无法对评论和回复等继续删除。也就是说这种对数据库事务的操作无法做到级联删除。
          **解决办法：**
      
          >      1. 在写完comment，reply的Service之后，在该service中分别创建实例，然后通过创建的实例调用其删除方法，对其进行删除。这样在删除贴吧时就要对post，comment，reply这三个分别调用单独的删除方法【这里还需要对每个service中提供相应的单独删除的方法，这样就会导致在一个service中包含多个删除操作{单独删除，事务删除}】，然后通过posts的事务，对其进行统一删除，同样的到post，comment需要做同样的操作（不推荐）
          > ​      2. （还未验证可行性）给每个service中都添加事务，从reply开始，到posts结束，逐层递增事务中的删除操作。并通过spring提供的事务的传播，对事务进行由下到上的删除。即：在对posts进行删除的时候，其方法中只是对posts记录的删除，但其中同时调用了post对post本身和comment的删除的事务。并不断传递下去，直到reply中的事务，仅仅对自己删除即可。
      
      12. 在实现的过程中，利用了java的反射写了一些比较有意义的util，在实现代码的优化的同时，也复习了一下关于反射的相关知识。
      
      13. 在实现的过程中确定了，UserToRole表中的所有service都封装进postsService中，以方便调用。（主要是UserToRole这个表可以视为为每个posts单独创建的用于管理用户状态的表。所以并不会造成冲突）
      
      14. 对message进行了提取和规划，形成了一个properties文件，并利用自己编写的propertiesLoader对properties文件进行取值，但目前未解决properties文件读取的value在写入json时出现乱码的情况。
      
      16. 自定义了一些异常，枚举类。
      
      16. 在controller层将service层抛出的自定义异常捕获并转为message放入map中。
      
   2. **前端**
      1. 目前对于前端的处理打算分为两个方向，一个大主题，和一个主要坚持。
         1. 两个方向分别为：小程序，webapp。主要方向为webapp，如果想要做成小程序，那么后端很多接口都需要进行修改。
         2. 一个大主题就是想使用组件化开发的模式，进行前端设计。
         3. 一个主要坚持就是，坚决不用jsp以及类似的高耦合的前端做view！！！！！只使用前后端分离的结构思路进行编程。
      2. 目前想使用vue写前端
      3. 对于ajax的使用，可以使用jquery框架下的，但如果有可能还是可以尝试一下axios。

## 问题总结

1. 在最开始设计的时候并未考虑到有dto这么方便的东西存在，所以导致所有的传输都使用的是Map的形式，后期可能会对整体代码全部翻修，变为dto的形式传输json数据。
2. 由于英文不太好，所以此次开发中的所有内容（content）全部写成了上下文（context）。
3. 目前所有的后端接口都没有任何风格上的约束，未来打算修改为restful风格。
4. 目前还没有写各种跳转的接口，后面记得补充
5. 如果有可能会用一点点设计模式，优化代码。

